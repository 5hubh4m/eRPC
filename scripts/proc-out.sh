#!/bin/bash
# Process the output of each machine in /tmp/$autorun_app

source $(dirname $0)/utils.sh

# We need the node list, but don't overwrite the nodemap generated by run-all.sh
autorun_gen_nodes=1
overwrite_nodemap=0
source $(dirname $0)/autorun.sh

tmpdir=/tmp/proc_$autorun_app
rm -rf $tmpdir
mkdir $tmpdir

node_index=0
for node in $autorun_nodes; do
	# We don't have the node name to machine ID mapping here, so just use index
  target_filename=$autorun_app"_"$node_index

	echo "Fetching $tmpdir/$target_filename from $node."
  scp $node:/tmp/$autorun_app $tmpdir/$target_filename \
		1>/dev/null 2>/dev/null &

  ((node_index+=1))
done
wait
echo "Finished fetching files."

num_columns=`cat $tmpdir/* | head -1 | wc -w`
echo "Detected $num_columns columns"

# Process the accumulated output files. This assumes that the files have
# space-separated numbers in columns.

tot_rows="0"
avg[0]="" # Per-column average
for col in `seq 1 $num_columns`; do
  avg[$col]="0.0"
done

for filename in $tmpdir/*; do
  echo "Processing file $filename. Total rows processed = $tot_rows"

  # Ignore files with less than 12 lines
  lines_in_file=`cat $filename | wc -l`
  if [ $lines_in_file -le 12 ]; then
    blue "Ignoring $filename. Too short."
    continue;
  fi

  # Cut out the first 6 and last 6 lines
  awk -v nr="$(wc -l < $filename)" 'NR > 6 && NR < (nr - 6)' $filename > $tmpdir/compute_temp

  remaining_rows=`cat $tmpdir/compute_temp | wc -l`

  for col in `seq 1 $num_columns`; do
    file_avg=`awk -v col=$col '{ total += $col } END { printf "%.3f", total / NR  }' $filename`
    #echo "file_avg = $file_avg"
    prev_sum=`echo "scale=3; ${avg[$col]} * $tot_rows" | bc -l`
    #echo "prev_sum = $prev_sum"
    cur_sum=`echo "scale=3; $file_avg * $remaining_rows" | bc -l`
    #echo "cur_sum = $cur_sum"
    avg[$col]=`echo "scale=3; ($prev_sum + $cur_sum) / ($tot_rows + $remaining_rows)" | bc -l`
    echo "Column $col average for $filename = $file_avg. Current running average = ${avg[$col]}"
  done

  ((tot_rows+=$remaining_rows))
done

for col in `seq 1 $num_columns`; do
  blue "Final column $col average = ${avg[$col]}"
done
